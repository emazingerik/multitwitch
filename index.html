<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiTwitch Low Latency Mode</title>
  <style>
    body {
      margin: 0;
      background: #0e0e0e;
      color: white;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      flex-direction: column;
    }
    #controls {
      display: flex;
      padding: 10px;
      background: #1a1a1a;
      align-items: center;
      gap: 10px;
    }
    #stream-input {
      padding: 5px;
      font-size: 14px;
    }
    #add-stream {
      padding: 5px 10px;
      background: #272727;
      border: none;
      color: white;
      cursor: pointer;
    }
    #main {
      display: flex;
      flex-direction: row;
      width: 100%;
      height: 100%;
    }
    #multi-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 10px;
      overflow-y: auto;
    }
    .player-wrapper {
      background: #1a1a1a;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      position: relative;
    }
    .twitch-player {
      width: 100%;
      height: 50vh;
    }
    .fast-forward-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: #272727;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    #chat-panel {
      width: 350px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
    }
    #chat-tabs {
      display: flex;
      border-bottom: 1px solid #333;
    }
    .chat-tab {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      background: #1a1a1a;
      border: none;
      color: white;
    }
    .chat-tab.active {
      background: #272727;
      font-weight: bold;
    }
    #chat-frame {
      flex: 1;
      border: none;
      width: 100%;
    }
    #chat-toggle {
      padding: 5px;
      font-size: 12px;
      background: #111;
      border: none;
      color: white;
      cursor: pointer;
    }
  </style>
  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
  <div id="controls">
    <input type="text" id="stream-input" placeholder="Enter Twitch channel..." />
    <button id="add-stream">+</button>
  </div>
  <div id="main">
    <div id="multi-container"></div>
    <div id="chat-panel">
      <div id="chat-tabs"></div>
      <iframe id="chat-frame" src="" allowfullscreen></iframe>
      <button id="chat-toggle">Toggle Chat</button>
    </div>
  </div>

  <script>
    const container = document.getElementById('multi-container');
    const chatTabs = document.getElementById('chat-tabs');
    const chatFrame = document.getElementById('chat-frame');
    const chatToggle = document.getElementById('chat-toggle');
    const streamInput = document.getElementById('stream-input');
    const addStreamBtn = document.getElementById('add-stream');

    let channels = [];

    // Check URL for backup ?channels=... query
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('channels')) {
      const queryChannels = urlParams.get('channels').split(',').map(c => c.trim().toLowerCase());
      queryChannels.forEach(channel => {
        if (!channels.includes(channel)) {
          channels.push(channel);
          createPlayer(channel);
        }
      });
      if (channels.length > 0) chatTabs.firstChild?.click();
    }

    function createChatTab(channel) {
      const tab = document.createElement('button');
      tab.className = 'chat-tab';
      tab.textContent = channel;
      tab.onclick = () => {
        document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        chatFrame.src = `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}`;
      };
      chatTabs.appendChild(tab);
    }

    function createPlayer(channel) {
      const wrapper = document.createElement('div');
      wrapper.className = 'player-wrapper';

      const playerDiv = document.createElement('div');
      playerDiv.className = 'twitch-player';
      playerDiv.id = `player-${channel}`;
      wrapper.appendChild(playerDiv);

      const ffBtn = document.createElement('button');
      ffBtn.textContent = 'Fast Forward';
      ffBtn.className = 'fast-forward-btn';
      ffBtn.onclick = () => {
        const video = playerDiv.querySelector('video');
        if (video && video.seekable.length > 0) {
          video.currentTime = video.seekable.end(0) - 0.1;
        }
      };
      wrapper.appendChild(ffBtn);

      container.appendChild(wrapper);

      const player = new Twitch.Player(playerDiv.id, {
        channel,
        parent: [location.hostname],
        width: '100%',
        height: '100%',
        muted: true
      });

      player.addEventListener(Twitch.Player.READY, () => {
        try {
          const qualities = player.getQualities();
          if (qualities && qualities.length > 0) {
            player.setQuality(qualities[0].group);
            console.log(`[Shadow Script] Max quality applied to ${channel}`);
          }
        } catch (err) {
          console.warn(`[Shadow Script] Couldn't set quality for ${channel}`, err);
        }

        setInterval(() => {
          const video = playerDiv.querySelector('video');
          if (video?.seekable?.length) {
            const liveEdge = video.seekable.end(0);
            const delay = liveEdge - video.currentTime;
            if (delay > 10) {
              console.log(`[Shadow Script] ${channel} is ${delay.toFixed(1)}s behind. Consider refreshing.`);
            }

            const bonusBtn = document.querySelector('[data-test-selector="claimable-bonus-button__icon"]');
            if (bonusBtn) bonusBtn.click();
          }
        }, 30000);
      });

      createChatTab(channel);
    }

    chatToggle.onclick = () => {
      const panel = document.getElementById('chat-panel');
      panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
    }

    addStreamBtn.onclick = () => {
      const channel = streamInput.value.trim().toLowerCase();
      if (channel && !channels.includes(channel)) {
        channels.push(channel);
        createPlayer(channel);
        if (channels.length === 1) chatTabs.firstChild?.click();
        streamInput.value = '';
      }
    }
  </script>
</body>
</html>
