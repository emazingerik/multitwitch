<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiTwitch Low Latency Mode</title>
  <style>
    body {
      margin: 0;
      background: #0e0e0e;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    }

    .grid {
      display: grid;
      gap: 10px;
      padding: 10px;
    }

    .player-wrapper {
      display: flex;
      flex-direction: column;
      background: #1a1a1a;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }

    .twitch-player, .twitch-chat {
      width: 100%;
    }

    .twitch-player {
      height: 300px;
    }

    .twitch-chat {
      height: 250px;
      border: none;
    }

    @media(min-width: 768px) {
      .grid {
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      }
    }
  </style>
  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
  <script>
    // If the user hits a broken deep link, bounce back to root
    const pathname = location.pathname;
    const search = location.search;
    const hash = location.hash;
    const parts = pathname.split("/").filter(Boolean);
    if (!parts.includes("multitwitch")) {
      location.replace(`/multitwitch/${search}${hash}`);
    }
  </script>

  <h1 style="text-align:center; padding: 10px;">MultiTwitch Low Latency</h1>
  <div class="grid" id="multi-container"></div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let channels = [];

    // Grab all path segments
    const pathSegments = window.location.pathname.split('/').filter(Boolean);
    const baseIndex = pathSegments.indexOf("multitwitch");
    if (urlParams.has('channels')) {
      channels = urlParams.get('channels').split(',');
    } else {
      channels = pathSegments.slice(baseIndex + 1);
    }

    const container = document.getElementById('multi-container');

    channels.forEach(channel => {
      const wrapper = document.createElement('div');
      wrapper.className = 'player-wrapper';

      const playerDiv = document.createElement('div');
      playerDiv.className = 'twitch-player';
      playerDiv.id = `player-${channel}`;
      wrapper.appendChild(playerDiv);

      const chatIframe = document.createElement('iframe');
      chatIframe.className = 'twitch-chat';
      chatIframe.src = `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}`;
      wrapper.appendChild(chatIframe);

      container.appendChild(wrapper);

      const player = new Twitch.Player(playerDiv.id, {
        channel,
        parent: [location.hostname],
        width: '100%',
        height: '100%',
        muted: true
      });

      player.addEventListener(Twitch.Player.READY, () => {
        try {
          const qualities = player.getQualities();
          if (qualities && qualities.length > 0) {
            player.setQuality(qualities[0].group);
            console.log(`[Shadow Script] Max quality applied to ${channel}`);
          }
        } catch (err) {
          console.warn(`[Shadow Script] Couldn't set quality for ${channel}`, err);
        }

        setInterval(() => {
          const video = playerDiv.querySelector('video');
          if (video?.seekable?.length) {
            const liveEdge = video.seekable.end(0);
            const delay = liveEdge - video.currentTime;
            if (delay > 10) {
              console.log(`[Shadow Script] ${channel} is ${delay.toFixed(1)}s behind. Consider refreshing.`);
            }
          }
        }, 30000);
      });
    });
  </script>
</body>
</html>
