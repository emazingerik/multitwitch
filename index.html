<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiTwitch Low Latency Mode</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }
    #main {
      display: flex;
      width: 100%;
      height: 100%;
      padding: 0;
      box-sizing: border-box;
    }
    #multi-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      align-content: center;
      gap: 10px;
      height: 100%;
      box-sizing: border-box;
    }
    .player-wrapper {
      position: relative;
      background: black;
      flex: 1 1 auto;
      height: 100vh;
      width: 100%;
      max-width: none;
      margin: 0;
      border-radius: 0;
    }
    }
    .twitch-player {
      width: 100%;
      height: 100%;
      background: black;
      border-radius: 3px;
    }
    .fast-forward-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .player-wrapper:hover .fast-forward-btn {
      opacity: 1;
    }
    #chat-panel {
      width: 350px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      border-radius: 8px;
      overflow: hidden;
      height: 100%;
    }
    #chat-tabs {
      display: flex;
      border-bottom: 1px solid #333;
    }
    .chat-tab {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      background: #1a1a1a;
      border: none;
      color: white;
    }
    .chat-tab.active {
      background: #272727;
      font-weight: bold;
    }
    #chat-frame {
      flex: 1;
      border: none;
      width: 100%;
    }
    #chat-toggle {
      padding: 5px;
      font-size: 12px;
      background: #111;
      border: none;
      color: white;
      cursor: pointer;
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 9999;
      display: block;
    }
  @media (max-width: 1200px) {
    .player-wrapper {
      flex: unset;
      max-width: none;
      min-width: unset;
    }
  }
  }
  }
  }
</style>
  <script src="https://player.twitch.tv/js/embed/v1.js">function adjustSinglePlayerLayout() {
  const allPlayers = document.querySelectorAll('.player-wrapper');
  allPlayers.forEach(p => p.style.maxWidth = allPlayers.length === 1 ? '100%' : '48%');
}

const observer = new MutationObserver(adjustSinglePlayerLayout);
observer.observe(document.getElementById('multi-container'), { childList: true });

adjustSinglePlayerLayout();
function adjustSinglePlayerLayout() {
  const allPlayers = document.querySelectorAll('.player-wrapper');
  allPlayers.forEach(p => {
    if (allPlayers.length === 1) {
      p.style.maxWidth = '100%';
      p.style.flex = '1 1 100%';
    } else {
      p.style.maxWidth = '48%';
      p.style.flex = '1 1 48%';
    }
  });
}

const observer = new MutationObserver(adjustSinglePlayerLayout);
observer.observe(document.getElementById('multi-container'), { childList: true });

adjustSinglePlayerLayout();
function adjustLayout() {
  const allPlayers = document.querySelectorAll('.player-wrapper');
  const container = document.getElementById('multi-container');

  allPlayers.forEach(p => {
    if (allPlayers.length === 1) {
      p.style.maxWidth = '100%';
      p.style.flex = '1 1 100%';
    } else {
      p.style.maxWidth = '48%';
      p.style.flex = '1 1 48%';
    }
  });

  container.style.justifyContent = 'center';
  container.style.alignItems = 'center';
  container.style.alignContent = 'center';
} else if (allPlayers.length === 2) {
      p.style.maxWidth = 'calc(50% - 20px)';
      p.style.flex = '1 1 calc(50% - 20px)';
    } else {
      p.style.maxWidth = 'calc(33% - 20px)';
      p.style.flex = '1 1 calc(33% - 20px)';
    }
  });

  container.style.justifyContent = 'center';
  container.style.alignItems = 'center';
  container.style.alignContent = 'center';
} else {
      p.style.maxWidth = '48%';
      p.style.flex = '1 1 48%';
    }
  });

  container.style.justifyContent = 'center';
  container.style.alignItems = 'center';
  container.style.alignContent = 'center';
} else {
      p.style.maxWidth = '48%';
      p.style.flex = '1 1 48%';
    }
  });

  container.style.justifyContent = 'center';
  container.style.alignItems = 'center';
  container.style.alignContent = 'center';
} else {
      p.style.maxWidth = '48%';
      p.style.flex = '1 1 48%';
    }
  });
}

const layoutObserver = new MutationObserver(adjustLayout);
layoutObserver.observe(document.getElementById('multi-container'), { childList: true });

adjustLayout();
function adjustLayout() {
  const allPlayers = document.querySelectorAll('.player-wrapper');
  allPlayers.forEach(p => {
    if (allPlayers.length === 1) {
      p.style.maxWidth = '100%';
      p.style.flex = '1 1 100%';
    } else {
      p.style.maxWidth = '48%';
      p.style.flex = '1 1 48%';
    }
  });
  const container = document.getElementById('multi-container');
  container.style.justifyContent = 'center';
  container.style.alignItems = 'center';
  container.style.alignContent = 'center';
}

const layoutObserver = new MutationObserver(adjustLayout);
layoutObserver.observe(document.getElementById('multi-container'), { childList: true });

adjustLayout();
</script>
</head>
<body>
  <div id="main" style="display: flex; gap: 10px; height: 100vh; position: relative;">
    <div id="multi-container"></div>
    <div id="chat-panel" style="display: flex; flex-direction: column; position: relative; z-index: 1; height: 100%;">
      <div style="padding: 10px; display: flex; gap: 8px; align-items: center; background: #1a1a1a; flex-direction: column;">
        <div style="display: flex; width: 100%; gap: 8px;">
          <input type="text" id="chat-stream-input" placeholder="Enter Twitch channel..." style="flex: 1; padding: 6px; border-radius: 4px; border: none; font-size: 14px;" />
          <button id="chat-add-stream" style="padding: 6px 10px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">+</button>
        </div>
        <select id="history-dropdown" style="width: 100%; padding: 5px; border-radius: 4px; font-size: 14px; background: #111; color: white;">
          <option value="">Recent Streamers</option>
        </select>
      </div>
      <div id="chat-tabs"></div>
      <iframe id="chat-frame" src="" allowfullscreen></iframe>
      
    </div>
</div>
<button id="chat-toggle" style="position: fixed; bottom: 10px; right: 10px; z-index: 10000; background: #222; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Hide Chat</button>
<script>
    let channels = [];
    let recentHistory = [];

    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('multi-container');
      const chatTabs = document.getElementById('chat-tabs');
      const chatFrame = document.getElementById('chat-frame');
      const chatToggle = document.getElementById('chat-toggle');
      const chatInput = document.getElementById('chat-stream-input');
      const chatAddBtn = document.getElementById('chat-add-stream');
      const historyDropdown = document.getElementById('history-dropdown');

      chatAddBtn.onclick = addStreamFromInput;
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addStreamFromInput();
      });

      historyDropdown.onchange = (e) => {
        const value = e.target.value;
        if (value && !channels.includes(value)) {
          channels.push(value);
          createPlayer(value);
          if (channels.length === 1) chatTabs.firstChild?.click();
        }
      };

      function addStreamFromInput() {
        const channel = chatInput.value.trim().toLowerCase();
        if (!channel) {
          alert('Please enter a channel name.');
          return;
        }
        if (channels.includes(channel)) {
          alert(`Channel "${channel}" is already added.`);
          chatInput.value = '';
          return;
        }
        channels.push(channel);
        createPlayer(channel);
        if (channels.length === 1) chatTabs.firstChild?.click();
        chatInput.value = '';
        if (!recentHistory.includes(channel)) {
          recentHistory.unshift(channel);
          if (recentHistory.length > 10) recentHistory.pop();
          updateHistoryDropdown();
        }
      }

      function updateHistoryDropdown() {
        historyDropdown.innerHTML = '<option value="">Recent Streamers</option>';
        recentHistory.forEach(user => {
          const option = document.createElement('option');
          option.value = user;
          option.textContent = user;
          historyDropdown.appendChild(option);
        });
      }

      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('channels')) {
        const queryChannels = urlParams.get('channels').split(',').map(c => c.trim().toLowerCase());
        queryChannels.forEach(channel => {
          if (!channels.includes(channel)) {
            channels.push(channel);
            createPlayer(channel);
          }
        });
        if (channels.length > 0) chatTabs.firstChild?.click();
      }

      function createChatTab(channel) {
        const tab = document.createElement('button');
        tab.className = 'chat-tab';
        tab.textContent = channel;
        tab.onclick = () => {
          document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          chatFrame.src = `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}`;
        };
        const closeTab = document.createElement('span');
        closeTab.textContent = ' ✕';
        closeTab.style.cursor = 'pointer';
        closeTab.style.marginLeft = '6px';
        closeTab.style.color = '#f66';
        closeTab.onclick = (e) => {
          e.stopPropagation();
          removeStream(channel);
        };
        tab.appendChild(closeTab);
        chatTabs.appendChild(tab);
      }

      function createPlayer(channel) {
        const wrapper = document.createElement('div');
        wrapper.className = 'player-wrapper';
        wrapper.setAttribute('data-channel', channel);

        const playerDiv = document.createElement('div');
        playerDiv.className = 'twitch-player';
        playerDiv.id = `player-${channel}`;
        wrapper.appendChild(playerDiv);

        const ffBtn = document.createElement('button');
        ffBtn.textContent = 'Fast Forward';
        ffBtn.className = 'fast-forward-btn';
        ffBtn.onclick = () => {
  const iframe = document.getElementById(`player-${channel}`);
  const video = iframe?.querySelector('video');
  if (video && video.seekable.length > 0) {
    video.currentTime = video.seekable.end(0) - 0.1;
    console.log(`[Shadow Script] Fast forwarded ${channel}`);
  } else {
    console.log(`[Shadow Script] No video element found for ${channel}`);
  }
};
        wrapper.appendChild(ffBtn);

        const removeBtn = document.createElement('button');
        removeBtn.textContent = '✕';
        removeBtn.style.position = 'absolute';
        removeBtn.style.top = '10px';
        removeBtn.style.left = '10px';
        removeBtn.style.background = 'rgba(255, 0, 0, 0.6)';
        removeBtn.style.border = 'none';
        removeBtn.style.color = 'white';
        removeBtn.style.padding = '4px 8px';
        removeBtn.style.borderRadius = '4px';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.fontSize = '12px';
        removeBtn.style.opacity = '0';
        removeBtn.style.transition = 'opacity 0.2s ease';
        removeBtn.onclick = () => removeStream(channel);
        wrapper.appendChild(removeBtn);

        wrapper.addEventListener('mouseenter', () => {
          ffBtn.style.opacity = '1';
          removeBtn.style.opacity = '1';
        });
        wrapper.addEventListener('mouseleave', () => {
          ffBtn.style.opacity = '0';
          removeBtn.style.opacity = '0';
        });

        container.appendChild(wrapper);

        const player = new Twitch.Player(playerDiv.id, {
          channel,
          parent: [location.hostname],
          width: '100%',
          height: '100%',
          muted: true
        });

        player.addEventListener(Twitch.Player.READY, () => {
          try {
            const qualities = player.getQualities();
            if (qualities && qualities.length > 0) {
              player.setQuality(qualities[0].group);
              console.log(`[Shadow Script] Max quality applied to ${channel}`);
            }
          } catch (err) {
            console.warn(`[Shadow Script] Couldn't set quality for ${channel}`, err);
          }

          setInterval(() => {
            const video = playerDiv.querySelector('video');
            if (video?.seekable?.length) {
              const liveEdge = video.seekable.end(0);
              const delay = liveEdge - video.currentTime;
              if (delay > 10) {
                console.log(`[Shadow Script] ${channel} is ${delay.toFixed(1)}s behind. Consider refreshing.`);
              }
              const bonusBtn = document.querySelector('[data-test-selector="claimable-bonus-button__icon"]');
              if (bonusBtn) bonusBtn.click();
            }
          }, 30000);
        });

        createChatTab(channel);
      }

      chatToggle.onclick = () => {
        const panel = document.getElementById('chat-panel');
        panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        chatToggle.textContent = panel.style.display === 'none' ? 'Show Chat' : 'Hide Chat';
      };
    });
  </script>
</body>
</html>
