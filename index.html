<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiTwitch Low Latency Mode</title>
  <style>
    body {
      margin: 0;
      background: #0e0e0e;
      color: white;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #main {
      display: flex;
      flex: 1;
      height: 100vh;
    }

    #multi-container {
      flex: 1;
      display: grid;
      padding: 10px;
      gap: 10px;
      overflow-y: auto;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .player-wrapper {
      background: #1a1a1a;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
    }

    .twitch-player {
      width: 100%;
      aspect-ratio: 16/9;
    }

    #chat-panel {
      width: 350px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
    }

    #chat-tabs {
      display: flex;
      border-bottom: 1px solid #333;
    }

    .chat-tab {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      background: #1a1a1a;
      border: none;
      color: white;
    }

    .chat-tab.active {
      background: #272727;
      font-weight: bold;
    }

    #chat-frame {
      flex: 1;
      border: none;
      width: 100%;
    }
  </style>
  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
  <div id="main">
    <div id="multi-container"></div>
    <div id="chat-panel">
      <div id="chat-tabs"></div>
      <iframe id="chat-frame" src="" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let channels = [];
    const pathSegments = window.location.pathname.split('/').filter(Boolean);
    const baseIndex = pathSegments.indexOf("multitwitch");
    if (urlParams.has('channels')) {
      channels = urlParams.get('channels').split(',');
    } else if (baseIndex !== -1) {
      channels = pathSegments.slice(baseIndex + 1);
    }

    const container = document.getElementById('multi-container');
    const chatTabs = document.getElementById('chat-tabs');
    const chatFrame = document.getElementById('chat-frame');

    function createChatTab(channel) {
      const tab = document.createElement('button');
      tab.className = 'chat-tab';
      tab.textContent = channel;
      tab.onclick = () => {
        document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        chatFrame.src = `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}`;
      };
      chatTabs.appendChild(tab);
    }

    channels.forEach((channel, i) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'player-wrapper';

      const playerDiv = document.createElement('div');
      playerDiv.className = 'twitch-player';
      playerDiv.id = `player-${channel}`;
      wrapper.appendChild(playerDiv);

      container.appendChild(wrapper);

      const player = new Twitch.Player(playerDiv.id, {
        channel,
        parent: [location.hostname],
        width: '100%',
        height: '100%',
        muted: true
      });

      player.addEventListener(Twitch.Player.READY, () => {
        try {
          const qualities = player.getQualities();
          if (qualities && qualities.length > 0) {
            player.setQuality(qualities[0].group);
            console.log(`[Shadow Script] Max quality applied to ${channel}`);
          }
        } catch (err) {
          console.warn(`[Shadow Script] Couldn't set quality for ${channel}`, err);
        }

        setInterval(() => {
          const video = playerDiv.querySelector('video');
          if (video?.seekable?.length) {
            const liveEdge = video.seekable.end(0);
            const delay = liveEdge - video.currentTime;
            if (delay > 10) {
              console.log(`[Shadow Script] ${channel} is ${delay.toFixed(1)}s behind. Consider refreshing.`);
            }
          }
        }, 30000);
      });

      createChatTab(channel);
    });

    // Activate first chat tab by default
    if (channels.length > 0) {
      chatTabs.firstChild.click();
    }
  </script>
</body>
</html>
